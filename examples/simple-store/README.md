# How create a simple store with the Redwoodjs-stripe plugin

This is just a simple store example that uses Auth0 for authentication.

1. Create a redwoodjs app
```js
  yarn  create  redwood-app  simple-store
```
2. Install plugin. Have your Stripe API keys near. If you don't already have products linked to your Stripe account then you can have dummy products added.

```js
  npx @redwoodjs-stripe/cli@latest  setup
  yarn  install
```
3. Change the exported `Routes` function in the `web/src/Routes.jsx` file to:
```js
const  Routes  = () => {
  return (
    <Router>
      <Route  path="/"  page={HomePage}  name="home"  prerender/>
      <Route  notfound  page={NotFoundPage}  />
    </Router>
  )
}
```
4. Set up authentication. For simplicity use [auth0](https://docs.redwoodjs.com/docs/auth/auth0) authentication. Change `web/src/pages/HomePage/HomePage.jsx` to include a sign up and log out button
```js
import { useAuth } from  'src/auth'
...
const  HomePage  = () => {
const [isCartVisible, setCartVisibilty] =  useState(false)
const { isAuthenticated, signUp, logOut} =  useAuth()
...
  <div  className="rws-header__actions">
    {/* Auth0 */}
    {isAuthenticated ? (
      <button  onClick={logOut}>Log out</button>
    ) : (
      <button  onClick={signUp}>Sign up</button>
    )}
    {/* Redirects to Stripe Customer Portal */}
    <StripeCustomerPortalButton  isLoggedIn={isAuthenticated  }  />
    ...
</div>
```
5. Set up the StripeProvider to use user email to get Stripe Customer id. There's a few approaches to linking your Auth0 user to their Stripe Customer.

When using Auth0 it's pretty simple to link your Stripe Customers and Auth0 Users using Actions. There's already an integration that will add a `stripe_customer_id` to the Auth0 user metadata. You can follow this detailed (tutorial)[https://developer.auth0.com/resources/labs/actions/sync-stripe-customers-and-auth0-users#introduction] on the auth0 website or if you are familiar with Auth0 actions just copy this code into a "Stripe Integration" action triggered "Post-login". Don't forget to add your Stripe Secret Key to your Auth0 Secrets and to add `stripe` as a dependency!

Action code:

```js
exports.onExecutePostLogin = async (event, api) => {
  try {
    /**
     * Check if new Auth0 user
     */
    if (event.stats.logins_count !== 1) {
      return;
    }

    /**
     * Check for data integrity
     */

    if (event.user.app_metadata.stripe_customer_id) {
      const error = `app_metadata for new user already has stripe_customer_id property.`;

      console.error(error);

      api.access.deny(
        "We could not create your account.\n" +
          "Please contact support for assistance."
      );

      return;
    }

    /**
     * Initialize Stripe library
     */

    const stripe = require("stripe")(event.secrets.STRIPE_SECRET_KEY);

    /**
     * Check if existing Stripe Customer
     */

    const stripeCustomerMatchesByEmail = await stripe.customers.list({
      email: event.user.email,
    });

    if (stripeCustomerMatchesByEmail.data.length > 0) {
      const error = `Stripe Customer with email ${event.user.email} already exists.`;

      console.error(error);

      api.access.deny(
        "We could not create your account.\n" +
          "Please contact support for assistance."
      );

      return;
    }

    /**
     * Create Stripe Customer
     */

    const newStripeCustomer = await stripe.customers.create({
      email: event.user.email,
      description: "Automatically generated by an Auth0 Action",
      metadata: { auth0_user_id: event.user.user_id },
    });

    /**
     * Add Stripe Customer ID to app_metadata
     */

    api.user.setAppMetadata("stripe_customer_id", newStripeCustomer.id);
  } catch (error) {
    console.error(error.message);

    api.access.deny(
      "We could not create your account.\n" +
        "Please contact support for assistance."
    );
  }
};
```

Linking to `StripeProvider`:

```js

// TODO Add example
```

Another less intense
